---
title: "COVID-19 EDA"
author: 
        - Byron Smith (300504707)
        - Iona Sammons (300281718)
        - Lauren Halka
date: "05/08/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background and Data

### Dataset and Source
The dataset we are using is the `Covid 19 data portal` dataset developed and maintained by Stats NZ. The source of the data is from numerous sources including New Zealand government agencies such as the Reserve Bank of New Zealand, The Treasury and the Ministry of Social Development, banks and other international sources.

### Why is the dataset of interest?
The data set includes data on three main categories; Economic, Health and Social. Each of these categories has a number of sub categories which have different indicators such as, Boradband Usage and Border Crossings. The majority of the indicators are New Zealand based but there are also a few indicators to do with other countries eg. US Economic Index.  

  As most of the data is New Zealand based, it will be useful for answering a number of questions about the impact of COVID-19 and the Alert Level restrictions. An example of a question we may want to answer is: What is the effect of an Alert Level increase/ decrease on the NZD foreign exchange rate with USD? To answer this we would look at the timeseries data on NZD/USD exchange and find the Alert Level announcement and commencement dates.
  
  Another question we could look at is: How many people have not left New Zealand due to COVID-19? This would be answered by looking at daily border crossings (departures), where we would model a prediction, had COVID-19 not had any effect, versus what we actually saw.

### Data types and structure

##### Structure 
The dataset is structured in a tree like pattern, where there are four main classes, which each have a number of categories with a number of indicators. Some indicators also contain sub-categories which splits the data into categories such as City or Type of Passport. This is represented in the dataset with columns called `class`, `category`, `indicator_name` and `sub_series`. 

  Some indicators also have multiple series which cover the same time period. For example the indicator `Card transaction total spend` has the actual amount spent, the seasonally adjusted amount spent and the number of transactions.

  There are three columns which contain the actual time series information. These columns have the date, value and unit of measure. The values of different indicators have a number of units of measure including dollars, tonnes, percentage, percentage per annum, index and number.  
  
  The last column is the date that the data for the indicator was last updated. This appears to apply to all the indicator values for all dates and not just the most recent value added to the indicator.
  
##### Types
All the columns in the dataset are character types. The columns `parameter` and `value` will need to be changed to other types before these columns can be used. However, as some values are integers while others are floats it would be wise to only change the type once we have extracted the subset we are going to work on. Similarly with the dates, the formats are generally the same but differ for certain indicators.

### Completeness and Correctness
The dataset has 76 rows that have missing values in the `value` column. These missing values are mostly limited to three indicators and cover a certain time period for each indicator: Electricity Grid Demand (Oct 2003 - Mar 2005), New Jobs Posted Online (Oct 2003 - Dec 2004), Christchurch Heavy Vehicles (03 Dec 2018 - 05 Mar 2019). There is also one row with a missing value for the indicator, Fuel Supply.   

  As the dataset is so large it is hard to determine if there are obvious errors in the data. We will need to wait until we are looking at subsets of the data to pick up on any errors. However, we have visualized different subsets of the data using the Stats NZ COVID-19 data portal tool and have not seen any obvious errors so we can be relatively confident the majority of the data is error free.


### Integration steps

---

## Ethics, Privacy and Security

### Ethical Considerations

### Privacy Concerns

### Security of data

---

## Exploratory Data Analysis

### Overall EDA
```{r message = FALSE}
# import packages
library(dplyr)
```
```{r}
# import the data set
covid <- read.csv("covid_19_data_portal.csv", header = TRUE, stringsAsFactors = FALSE)
```
```{r}
# check how many rows have missing values
nrow(covid[rowSums(is.na(covid)) > 0,])
```
```{r}
# remove rows with NA
covid <- na.omit(covid)
```

```{r}
head(covid)
```

### EDA 1



```{r}
length(unique(covid$indicator_name))
```


The function `get.frequency` finds the frequency of instances of a given dataset (subset of covid with a single indicator)
```{r message = F}
library(xts)
# get the time frequency 
# df : subset of covid with one indicator_name value
get.frequency <- function(df) {
  # check if indicator has multiple series
  ind.sub <- df
  if(length(unique(ind.sub$series_name)) > 1 || length(unique(ind.sub$sub_series_name)) > 1){
    ind.sub <- get.single.series(ind.sub)
  }
  # get time frequency of instances with periodicity function
  avg.dif <- periodicity(ind.sub$parameter)
  return(avg.dif$scale)
}
```

The function `get.single.series` removes all but one series / sub series so that only one time period is left.
```{r}
# get the single series for indicator
get.single.series <- function(df) {
  ans <- df %>% filter(series_name == unique(df$series_name)[1])
  # check for multiple sub series
  if(length(unique(ans$sub_series_name)) > 1)
    ans <- ans %>% filter(sub_series_name == unique(df$sub_series_name)[1])
  return(ans)
}
```

Here we create a new data frame of all the indicators and their frequencies. We get a table with frequency counts and `ind.freqs.df`, which can be used to filter the large data set by frequency or lookup the frequency for an indicator.
```{r message = F}
# get instance frequency for all indicators
# convert parameter to date
covid.1 <- covid
covid.1$parameter <- as.Date(covid.1$parameter)
# remove NA dates
covid.1 <- na.omit(covid.1)

indicators <- unique(covid.1$indicator_name)
frequency <- c()
for(i in 1:length(indicators)) {
  ind.sub <- covid.1 %>% filter(indicator_name == indicators[i])
  frequency <- append(frequency, get.frequency(ind.sub))
}
ind.freqs <- cbind(indicators, frequency)
ind.freqs.df <- as.data.frame(ind.freqs)

freq.totals <- ind.freqs.df %>% group_by(frequency) %>% summarise(total = n()) %>% arrange(total)
```
```{r}
library(ggplot2)
ggplot(freq.totals, aes(x=reorder(frequency, total), y=total)) +
  geom_bar(stat="identity", fill = "steelblue") + 
  geom_text(aes(label=total), vjust=1.6, color="white", size=3.5) +
  labs(x = "Frequency", y = "Number of indicators", title = "Instance frequencies of indicators in COVID-19 dataset") +
  theme(panel.background = element_rect(fill = "white", colour = "gray90", size = 1),
          panel.grid.major = element_line(size = 0.7, linetype = 'solid', colour = "gray97"))
```
  
The COVID-19 dataset contains daily, weekly and monthly timeseries data. The majority of the indicators have monthly instances. 


##### Time period covered
When looking at what questions we may be able to answer with this data we also need to know how much information we have for each indicator in terms of time period covered. We will add this information to the dataframe holding the indicator frequencies to gain more insight about the indicators overall.

```{r}
# get start and end dates for each predictor
start.date = c()
end.date = c()
for(i in 1:nrow(ind.freqs.df)){
  tmp <- covid.1 %>% filter(indicator_name == ind.freqs.df$indicators[i])
  start.date <- append(start.date, tmp$parameter[1])
  end.date <- append(end.date, tmp$parameter[nrow(tmp)])
}

# create a data frame with indicator info (add to frequency data)
indicator.info <- ind.freqs.df
indicator.info$start.date <- start.date
indicator.info$end.date <- end.date
# make new column with approximate length (days and months and years)
indicator.info <- indicator.info %>% 
  mutate(time.range.day = end.date - start.date, 
         time.range.month = round((end.date - start.date) / 30),
         time.range.year = round((end.date - start.date) / 365))
indicator.info$time.range.day <- as.numeric(indicator.info$time.range.day, units="days")
indicator.info$time.range.month <- as.numeric(indicator.info$time.range.month, units="days")
indicator.info$time.range.year <- as.numeric(indicator.info$time.range.year, units="days")
```
```{r}
ggplot(indicator.info, aes(x = time.range.year)) + 
  geom_histogram(binwidth = 1, alpha = 0.8, fill = "steelblue") +
  labs(x = "Years of data", y = "Number of indicators", title = "Indicator time range") +
  theme(panel.background = element_rect(fill = "white", colour = "gray90", size = 1),
          panel.grid.major = element_line(size = 0.7, linetype = 'solid', colour = "gray97"))
```

```{r}
ggplot(indicator.info, aes(x = time.range.year, fill = frequency)) + 
  geom_histogram(binwidth = 1, alpha = 0.8) +
  scale_fill_ordinal() +
  labs(x = "Years of data", y = "Number of indicators", title = "Indicator time range") +
  theme(panel.background = element_rect(fill = "white", colour = "gray90", size = 1),
          panel.grid.major = element_line(size = 0.7, linetype = 'solid', colour = "gray97"))
```

We can see that most indicators have a relatively short time frame with the majority only going back 1 year. We can also see that the indicators which have less than a years worth of data have short frequencies, daily and weekly. 

From this plot we can see that there are a few indicators which have a daily frequency and go back about 5 years.
```{r}
filter(indicator.info, time.range.year == 5 & frequency == "daily")$indicators
head(indicator.info)
```




### EDA 2
```{r}
# Select data that relates to departures
allDepartures <- filter(covid, indicator_name == "Daily border crossings - departures")

# Convert values from char to correct format
allDepartures$parameter <- as.Date(allDepartures$parameter, format="%Y-%m-%d")
allDepartures$value <- as.numeric(allDepartures$value)

# Select NZ passport departures
nzDepartures <- filter(allDepartures, series_name == "New Zealand passport")

# See what we gots...
plot(allDepartures$parameter, allDepartures$value)
plot(nzDepartures$parameter, nzDepartures$value)

# Narrow it down
firstReportedCase <- as.Date("2020-02-28")
bordersClosed <- as.Date("2020-03-19")
levelFour <- as.Date("2020-03-25")
MIQStarted <- as.Date("2020-04-10")
levelThree <- as.Date("2020-04-27")
levelTwo <- as.Date("2020-05-13")
levelOne <- as.Date("2020-06-08")
MIQFeeCameIntoEffect <- as.Date("2020-08-11")

recentNzDepartures <- filter(nzDepartures, parameter > firstReportedCase)
ggplot(recentNzDepartures, aes(x=parameter, y=value)) + 
  geom_line() +
  geom_vline(xintercept = bordersClosed, color = "blue") +
  geom_vline(xintercept = levelFour, color = "red") +
  geom_vline(xintercept = levelThree, color = "orange") +
  geom_vline(xintercept = levelTwo, color = "yellow") +
  geom_vline(xintercept = levelOne, color = "green") +
  geom_vline(xintercept = MIQFeeCameIntoEffect, color = "blue")
```

### EDA 3

---

## Individual Contributions









